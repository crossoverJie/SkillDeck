# release.yml — 标签触发的自动化发布工作流
#
# 当推送 v* 格式的 tag 时（如 v1.0.0），自动执行：
#   1. 运行测试确保代码质量
#   2. 构建通用二进制 .app bundle
#   3. 创建 GitHub Release 并上传 zip 文件
#
# 用法：
#   git tag v1.0.0
#   git push origin v1.0.0

name: Release

on:
  push:
    tags: ['v*']

# 权限设置：需要写入权限来创建 Release
permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    # 将 version 和 sha256 暴露为 job outputs，供下游 update-homebrew job 使用
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      sha256: ${{ steps.sha256.outputs.SHA256 }}
    steps:
      - uses: actions/checkout@v4

      - name: Print Swift version
        run: swift --version

      # 先运行测试，确保发布版本质量
      - name: Run tests
        run: swift test

      # 从 git tag 中提取版本号：v1.0.0 → 1.0.0
      # GITHUB_REF_NAME 是触发工作流的 tag 名称
      # ${GITHUB_REF_NAME#v} 是 bash 参数展开语法，去掉前缀 "v"
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      # 构建通用 .app bundle
      - name: Build .app bundle
        run: ./scripts/package-app.sh --version ${{ steps.version.outputs.VERSION }}

      # 验证构建产物的架构（应同时包含 arm64 和 x86_64）
      - name: Verify universal binary
        run: file build/SkillDeck.app/Contents/MacOS/SkillDeck

      # 使用 ditto 打包 zip（比 zip 命令更好地保留 macOS 元数据和权限）
      # --keepParent 保留 SkillDeck.app 目录结构
      - name: Create zip archive
        run: |
          cd build
          ditto -c -k --keepParent SkillDeck.app "SkillDeck-v${{ steps.version.outputs.VERSION }}-universal.zip"

      # 计算 zip 文件的 SHA256 哈希值，用于 Homebrew cask 校验
      # 直接从本地构建产物计算，避免从 GitHub Release 重新下载的竞态条件
      - name: Compute SHA256
        id: sha256
        run: |
          SHA=$(shasum -a 256 "build/SkillDeck-v${{ steps.version.outputs.VERSION }}-universal.zip" | awk '{print $1}')
          echo "SHA256=${SHA}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${SHA}"

      # 创建 GitHub Release 并上传构建产物
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/SkillDeck-v${{ steps.version.outputs.VERSION }}-universal.zip
          generate_release_notes: true
          name: ${{ github.ref_name }}

  # Homebrew cask 自动更新
  # 在 release 成功后，自动更新 homebrew-skilldeck 仓库的 cask 文件
  # 独立 job：失败不影响已发布的 Release，可单独重跑
  # 使用 ubuntu-latest（只需编辑文本+git push，不需要 macOS）
  update-homebrew:
    runs-on: ubuntu-latest
    needs: release
    steps:
      # 使用 PAT 克隆 homebrew tap 仓库，token 会自动配置到 git remote URL
      - name: Checkout homebrew-skilldeck
        uses: actions/checkout@v4
        with:
          repository: crossoverJie/homebrew-skilldeck
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      # sed -i 原地编辑，替换 version 和 sha256 行
      - name: Update cask version and SHA256
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SHA256="${{ needs.release.outputs.sha256 }}"
          echo "Updating cask to version ${VERSION}, sha256 ${SHA256}"
          sed -i "s/version \".*\"/version \"${VERSION}\"/" Casks/skilldeck.rb
          sed -i "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Casks/skilldeck.rb
          echo "--- Updated cask file ---"
          cat Casks/skilldeck.rb

      # 使用 github-actions bot 身份提交
      # git diff --cached --quiet 检查是否有实际变更，避免空提交
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/skilldeck.rb
          if git diff --cached --quiet; then
            echo "No changes to commit (version already up to date)"
          else
            git commit -m "bump skilldeck to v${{ needs.release.outputs.version }}"
            git push
            echo "Successfully pushed cask update"
          fi
